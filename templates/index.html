{% extends 'base.html' %}
{% block title %}æ–‡ä»¶ç®¡ç†{% endblock %}
{% block body %}
<div class="d-flex justify-content-between mb-3">
  <div>å½“å‰ç”¨æˆ·ï¼š{{ username }}</div>
  <div><a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary">é€€å‡º</a></div>
</div>
<h1 class="mb-3">æ–‡ä»¶ç®¡ç†</h1>
<nav>
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
    {% if cur_path %}
      {% set parts = cur_path.split('/') %}
      {% for i in range(parts|length) %}
        <li class="breadcrumb-item">
          <a href="{{ url_for('index', subpath=parts[:i+1]|join('/')) }}">{{ parts[i] }}</a>
        </li>
      {% endfor %}
    {% endif %}
  </ol>
</nav>

<div id="dropzone">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ <input id="fileInput" type="file" multiple style="display:none"></div>
<button id="btnNewFolder" class="btn btn-sm btn-secondary mb-3">æ–°å»ºæ–‡ä»¶å¤¹</button>

<table class="table table-striped">
  <thead><tr><th>åç§°</th><th>ç±»å‹</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="fileList">
    {% for e in entries %}
    <tr data-name="{{ e.name }}" data-isdir="{{ e.is_dir }}">
      <td>
        {% if e.is_dir %}
          ğŸ“ <a href="{{ url_for('index', subpath=(cur_path + '/' + e.name).lstrip('/')) }}">{{ e.name }}</a>
        {% else %}
          ğŸ“„ {{ e.name }}
        {% endif %}
      </td>
      <td>{{ 'æ–‡ä»¶å¤¹' if e.is_dir else 'æ–‡ä»¶' }}</td>
      <td>
        {% if not e.is_dir %}
          <a href="{{ url_for('download', subpath=cur_path, filename=e.name) }}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a>
          {% if e.name.lower().endswith(('.mp4','.webm')) %}
            <button class="btn btn-sm btn-outline-success play-video">æ’­æ”¾è§†é¢‘</button>
          {% elif e.name.lower().endswith(('.mp3','.wav')) %}
            <button class="btn btn-sm btn-outline-success play-audio">æ’­æ”¾éŸ³é¢‘</button>
          {% elif e.name.lower().endswith(('.txt','.md','.py','.html')) %}
            <button class="btn btn-sm btn-outline-warning edit-file">ç¼–è¾‘</button>
          {% endif %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<ul id="ctxMenu">
  <li id="ctxRename">é‡å‘½å</li>
  <li id="ctxDelete">åˆ é™¤</li>
</ul>

<!-- ç¼–è¾‘/æ’­æ”¾ æ¨¡æ€æ¡† -->
<div class="modal fade" id="modal" tabindex="-1"><div class="modal-dialog modal-lg">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="modalTitle"></h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFoot"></div>
  </div>
</div></div>
{% endblock %}

{% block script %}
<script>
let curPath = "{{ cur_path }}", selectedRow = null;

// æ‹–æ‹½ / ç‚¹å‡» ä¸Šä¼ 
$("#dropzone")
  .on("click", ()=> $("#fileInput").click())
  .on("dragover", e=>{ e.preventDefault(); })
  .on("drop", e=>{ e.preventDefault(); upload(e.originalEvent.dataTransfer.files); });
$("#fileInput").on("change", e=> upload(e.target.files));

function upload(files) {
  let fd = new FormData();
  for(let f of files) fd.append("file", f);
  fd.append("path", curPath);
  $.ajax({ url:"/upload", type:"POST", data:fd, processData:false, contentType:false })
    .done(()=>location.reload()).fail(err=>alert(err.responseText));
}

// æ–°å»ºæ–‡ä»¶å¤¹
$("#btnNewFolder").click(()=>{
  let name = prompt("æ–‡ä»¶å¤¹åç§°ï¼š");
  if(!name) return;
  $.ajax({
    url:"/mkdir", type:"POST", contentType:"application/json",
    data: JSON.stringify({ path:curPath, name:name })
  }).done(()=>location.reload()).fail(err=>alert(err.responseText));
});

// å³é”®èœå•
$(document).on("contextmenu", "tr", function(e){
  e.preventDefault(); selectedRow = $(this);
  $("#ctxMenu").css({ top:e.pageY, left:e.pageX }).show();
});
$(document).click(()=> $("#ctxMenu").hide());

// é‡å‘½å
$("#ctxRename").click(()=>{
  let oldName = selectedRow.data("name");
  let newName = prompt("æ–°åç§°ï¼š", oldName);
  if(!newName||newName===oldName) return;
  $.ajax({
    url:"/rename", type:"POST", contentType:"application/json",
    data: JSON.stringify({ path:curPath, old:oldName, new:newName })
  }).done(()=>location.reload()).fail(err=>alert(err.responseText));
});

// åˆ é™¤
$("#ctxDelete").click(()=>{
  let name = selectedRow.data("name");
  let isdir = selectedRow.data("isdir");
  if(!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ"))return;
  $.ajax({
    url:"/delete", type:"POST", contentType:"application/json",
    data: JSON.stringify({ path:curPath, name:name, isdir:isdir })
  }).done(()=>location.reload()).fail(err=>alert(err.responseText));
});

// ç¼–è¾‘æ–‡æœ¬
$(document).on("click", ".edit-file", function(){
  let name = $(this).closest("tr").data("name");
  $.get("/edit", { path:curPath, file:name }, data=>{
    $("#modalTitle").text("ç¼–è¾‘ï¼š" + name);
    $("#modalBody").html('<textarea id="editor" class="form-control" rows="15"></textarea>');
    $("#editor").val(data);
    $("#modalFoot").html('<button id="saveEdit" class="btn btn-primary">ä¿å­˜</button>');
    new bootstrap.Modal($("#modal")).show();
    $("#saveEdit").click(()=>{
      $.ajax({
        url:"/edit", type:"POST", contentType:"application/json",
        data: JSON.stringify({ path:curPath, file:name, content:$("#editor").val() })
      }).done(()=>location.reload()).fail(err=>alert(err.responseText));
    });
  });
});

// æ’­æ”¾è§†é¢‘
$(document).on("click", ".play-video", function(){
  let name = $(this).closest("tr").data("name");
  $("#modalTitle").text("è§†é¢‘ï¼š" + name);
  $("#modalBody").html(
    `<video controls style="width:100%" src="/media/${encodeURIComponent(curPath)}/${encodeURIComponent(name)}"></video>`
  );
  $("#modalFoot").html('');
  new bootstrap.Modal($("#modal")).show();
});

// æ’­æ”¾éŸ³é¢‘
$(document).on("click", ".play-audio", function(){
  let name = $(this).closest("tr").data("name");
  $("#modalTitle").text("éŸ³é¢‘ï¼š" + name);
  $("#modalBody").html(
    `<audio controls style="width:100%" src="/media/${encodeURIComponent(curPath)}/${encodeURIComponent(name)}"></audio>`
  );
  $("#modalFoot").html('');
  new bootstrap.Modal($("#modal")).show();
});
</script>
{% endblock %}
